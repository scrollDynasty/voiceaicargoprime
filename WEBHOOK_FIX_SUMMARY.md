# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è Webhook –¥–ª—è RingCentral

## üìã –û–±–∑–æ—Ä –ø—Ä–æ–±–ª–µ–º –∏ —Ä–µ—à–µ–Ω–∏–π

### üî¥ –ü—Ä–æ–±–ª–µ–º–∞ 1: –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞
**–ü—Ä–æ–±–ª–µ–º–∞**: –û–±—Ä–∞–±–æ—Ç–∫–∞ POST –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞—Ö–æ–¥–∏–ª–∞—Å—å –≤–Ω—É—Ç—Ä–∏ –±–ª–æ–∫–∞ GET –∑–∞–ø—Ä–æ—Å–æ–≤
**–†–µ—à–µ–Ω–∏–µ**: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —É—Å–ª–æ–≤–Ω–æ–π –ª–æ–≥–∏–∫–∏ –≤ —Ñ—É–Ω–∫—Ü–∏–∏ `ringcentral_webhook()`

### üî¥ –ü—Ä–æ–±–ª–µ–º–∞ 2: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–∞—Ä—Å–∏–Ω–≥ JSON
**–ü—Ä–æ–±–ª–µ–º–∞**: Flask –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—ã—Ç–∞–ª—Å—è –ø–∞—Ä—Å–∏—Ç—å JSON –¥–∞–∂–µ –¥–ª—è –ø—É—Å—Ç—ã—Ö POST –∑–∞–ø—Ä–æ—Å–æ–≤
**–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–ª–µ–Ω –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä `@disable_auto_json_parsing` –¥–ª—è –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞

### üî¥ –ü—Ä–æ–±–ª–µ–º–∞ 3: –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—É—Å—Ç—ã—Ö POST –∑–∞–ø—Ä–æ—Å–æ–≤
**–ü—Ä–æ–±–ª–µ–º–∞**: –ü—É—Å—Ç—ã–µ POST –∑–∞–ø—Ä–æ—Å—ã –≤—ã–∑—ã–≤–∞–ª–∏ –æ—à–∏–±–∫—É 500
**–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç–æ–µ —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞ –ø–µ—Ä–µ–¥ –ø–∞—Ä—Å–∏–Ω–≥–æ–º JSON

## ‚úÖ –í–Ω–µ—Å–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 1. –î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –∞–≤—Ç–æ–ø–∞—Ä—Å–∏–Ω–≥–∞ (—Å—Ç—Ä–æ–∫–∏ 45-66)
```python
def disable_auto_json_parsing(f):
    """
    –î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON
    Flask –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–∞—Ä—Å–∏—Ç JSON –∫–æ–≥–¥–∞ Content-Type: application/json
    –≠—Ç–æ—Ç –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∑–∞–ø—Ä–æ—Å –≤—Ä—É—á–Ω—É—é
    """
    @wraps(f)
    def decorated_function(*args, **kwargs):
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ get_json
        original_get_json = request.get_json
        
        # –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º get_json —á—Ç–æ–±—ã –æ–Ω –≤–æ–∑–≤—Ä–∞—â–∞–ª None
        request.get_json = lambda *args, **kwargs: None
        
        try:
            result = f(*args, **kwargs)
        finally:
            # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥
            request.get_json = original_get_json
        
        return result
    return decorated_function
```

### 2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ webhook (—Å—Ç—Ä–æ–∫–∏ 97-127)
```python
@app.route('/webhook', methods=['GET', 'POST'])
@disable_auto_json_parsing
def ringcentral_webhook():
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ webhook –æ—Ç RingCentral
    
    GET: –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ —Å hub.challenge
    POST: –û–±—Ä–∞–±–æ—Ç–∫–∞ webhook —Å–æ–±—ã—Ç–∏–π
    """
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ GET –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
    if request.method == 'GET':
        challenge = request.args.get('hub.challenge')
        if challenge:
            logger.info(f"–ü–æ–ª—É—á–µ–Ω validation challenge: {challenge}")
            return Response(challenge, content_type='text/plain')
        else:
            logger.warning("GET –∑–∞–ø—Ä–æ—Å –±–µ–∑ hub.challenge –ø–∞—Ä–∞–º–µ—Ç—Ä–∞")
            return jsonify({"error": "Missing hub.challenge"}), 400
    
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ POST –∑–∞–ø—Ä–æ—Å–æ–≤
    elif request.method == 'POST':
        # –õ–æ–≥–∏—Ä—É–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        logger.debug(f"Headers: {dict(request.headers)}")
        
        # –ü–æ–ª—É—á–∞–µ–º —Å—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ
        raw_data = request.get_data()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ
        if not raw_data:
            logger.info("–ü–æ–ª—É—á–µ–Ω –ø—É—Å—Ç–æ–π POST –∑–∞–ø—Ä–æ—Å –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ webhook")
            return jsonify({"status": "ok"}), 200
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ webhook (–¥–µ–ª–∞–µ–º –¥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON)
        if not _verify_webhook_signature(request):
            logger.warning("–ù–µ–≤–µ—Ä–Ω–∞—è –ø–æ–¥–ø–∏—Å—å webhook")
            return jsonify({"error": "Invalid signature"}), 401
        
        # –ü—ã—Ç–∞–µ–º—Å—è —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON
        try:
            webhook_data = json.loads(raw_data.decode('utf-8'))
        except json.JSONDecodeError as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON –¥–∞–Ω–Ω—ã—Ö: {e}")
            logger.error(f"Raw data: {raw_data[:500]}")  # –õ–æ–≥–∏—Ä—É–µ–º –ø–µ—Ä–≤—ã–µ 500 —Å–∏–º–≤–æ–ª–æ–≤
            return jsonify({"error": "Invalid JSON"}), 400
        
        logger.info(f"–ü–æ–ª—É—á–µ–Ω–æ webhook —Å–æ–±—ã—Ç–∏–µ: {json.dumps(webhook_data, indent=2)}")
        
        # –ò–∑–≤–ª–µ–∫–∞–µ–º body –∏–∑ webhook payload
        body = webhook_data.get('body', {})
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ telephonySessionId –¥–ª—è telephony —Å–æ–±—ã—Ç–∏–π
        if body.get('telephonySessionId'):
            return _handle_telephony_session(body)
        else:
            logger.info(f"–ù–µ telephony —Å–æ–±—ã—Ç–∏–µ: {webhook_data.get('uuid', 'unknown')}")
            return jsonify({"status": "received"}), 200
```

### 3. –£–ª—É—á—à–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (—Å—Ç—Ä–æ–∫–∏ 40-65)
```python
# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è Flask
app.logger.setLevel(logging.DEBUG)

# –î–æ–±–∞–≤–ª—è–µ–º middleware –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
@app.before_request
def log_request_info():
    """–õ–æ–≥–∏—Ä—É–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ"""
    logger.debug('=' * 80)
    logger.debug(f'Request: {request.method} {request.url}')
    logger.debug(f'Headers: {dict(request.headers)}')
    logger.debug(f'Content-Type: {request.content_type}')
    logger.debug(f'Content-Length: {request.content_length}')
    if request.method in ['POST', 'PUT', 'PATCH']:
        # –õ–æ–≥–∏—Ä—É–µ–º –ø–µ—Ä–≤—ã–µ 1000 —Å–∏–º–≤–æ–ª–æ–≤ —Ç–µ–ª–∞ –∑–∞–ø—Ä–æ—Å–∞
        data = request.get_data(as_text=True)
        if data:
            logger.debug(f'Body (first 1000 chars): {data[:1000]}')
        else:
            logger.debug('Body: <empty>')
    logger.debug('=' * 80)

@app.after_request
def log_response_info(response):
    """–õ–æ–≥–∏—Ä—É–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞–∂–¥–æ–º –æ—Ç–≤–µ—Ç–µ"""
    logger.debug(f'Response: {response.status}')
    return response
```

### 4. –£–ª—É—á—à–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ (—Å—Ç—Ä–æ–∫–∏ 154-205)
- –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ª—É—á–∞–µ–≤ –∫–æ–≥–¥–∞ –ø–æ–¥–ø–∏—Å—å –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è
- –î–æ–±–∞–≤–ª–µ–Ω –≤—ã–≤–æ–¥ —á–∞—Å—Ç–∏—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–¥–ø–∏—Å—è—Ö –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–°–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç `test_webhook.py` –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤:

1. **–ü—É—Å—Ç–æ–π POST –∑–∞–ø—Ä–æ—Å** - –¥–æ–ª–∂–µ–Ω –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å 200 OK
2. **GET —Å hub.challenge** - –¥–æ–ª–∂–µ–Ω –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å challenge –∫–∞–∫ plain text
3. **GET –±–µ–∑ hub.challenge** - –¥–æ–ª–∂–µ–Ω –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å 400 Bad Request
4. **POST —Å –≤–∞–ª–∏–¥–Ω—ã–º JSON** - –¥–æ–ª–∂–µ–Ω –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∏ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å 200 OK
5. **POST —Å –Ω–µ–≤–µ—Ä–Ω–æ–π –ø–æ–¥–ø–∏—Å—å—é** - –¥–æ–ª–∂–µ–Ω –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å 401 Unauthorized
6. **POST —Å –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–º JSON** - –¥–æ–ª–∂–µ–Ω –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å 400 Bad Request
7. **POST –±–µ–∑ Content-Type** - –¥–æ–ª–∂–µ–Ω –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
8. **Telephony —Å–æ–±—ã—Ç–∏–µ** - –¥–æ–ª–∂–µ–Ω –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –≤—Ö–æ–¥—è—â–∏–µ –∑–≤–æ–Ω–∫–∏

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤:
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å webhook —Å–µ—Ä–≤–µ—Ä
python webhook_server.py

# –í –¥—Ä—É–≥–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã
python test_webhook.py
```

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –≤–Ω–µ—Å–µ–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π:
- ‚úÖ RingCentral –º–æ–∂–µ—Ç —É—Å–ø–µ—à–Ω–æ –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å webhook
- ‚úÖ –ü—É—Å—Ç—ã–µ POST –∑–∞–ø—Ä–æ—Å—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ JSON –¥–∞–Ω–Ω—ã–µ –ø–∞—Ä—Å—è—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –æ–Ω–∏ –µ—Å—Ç—å
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –í—Å–µ —Ç–µ—Å—Ç–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –ø—Ä–æ—Ö–æ–¥—è—Ç —É—Å–ø–µ—à–Ω–æ

## üìù –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: –°–ª–µ–¥–∏—Ç–µ –∑–∞ –ª–æ–≥–∞–º–∏ –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º
2. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ webhook_secret –≤ production
3. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**: –î–æ–±–∞–≤—å—Ç–µ retry –ª–æ–≥–∏–∫—É –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
4. **–ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ**: –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –æ—á–µ—Ä–µ–¥–µ–π –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ webhook